name: CI/CD to Kubernetes

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Set Image Version
        id: version
        run: |
          VERSION=v${{ github.run_number }}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "Using version tag: $VERSION"

      - name: Build and Push Backend Image
        run: |
          docker build -t yash4200/insurance-backend:${{ env.VERSION }} ./backend
          docker push yash4200/insurance-backend:${{ env.VERSION }}

      - name: Build and Push Frontend Image
        run: |
          docker build -t yash4200/insurance-frontend:${{ env.VERSION }} ./frontend
          docker push yash4200/insurance-frontend:${{ env.VERSION }}

      - name: Deploy to Kubernetes on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          VERSION: v${{ github.run_number }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: VERSION
          script: |
            # 1. Load EVERY possible path into the environment
            export PATH=$PATH:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:/snap/bin:/opt/bin:/home/${{ secrets.EC2_USERNAME }}/.local/bin
            
            # 2. Dynamically discover the correct Kubernetes command
            if command -v kubectl >/dev/null 2>&1; then
                KUBE_CMD="kubectl"
            elif command -v k3s >/dev/null 2>&1; then
                KUBE_CMD="sudo k3s kubectl"
            elif command -v microk8s >/dev/null 2>&1; then
                KUBE_CMD="sudo microk8s kubectl"
            else
                echo "ERROR: No Kubernetes client found! Searched in: $PATH"
                echo "Running emergency search to find the binary..."
                sudo find / -name "kubectl" -type f -executable 2>/dev/null | head -n 3
                exit 1
            fi
            
            echo "Successfully found Kubernetes client. Using: $KUBE_CMD"
            
            # 3. Apply the rolling updates
            $KUBE_CMD set image deployment/backend backend=yash4200/insurance-backend:$VERSION
            $KUBE_CMD set image deployment/frontend frontend=yash4200/insurance-frontend:$VERSION
            
            # 4. Wait for rollouts WITH TIMEOUTS to prevent infinite hanging
            $KUBE_CMD rollout status deployment/backend --timeout=120s
            $KUBE_CMD rollout status deployment/frontend --timeout=120s
